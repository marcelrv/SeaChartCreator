pipeline {
    agent any
    parameters {
        string(name: 'BUNDLENAME', defaultValue: 'test', description: 'name of chart bundle')
        string(name: 'BUNDLEPATH', defaultValue: './sample/atlas/osmcb/sea', description: 'chart bundle path: ./sample/atlas/osmcb/sea , ./sample/atlas/mobac/inland-water-ways ')
    }
    
    stages {
        stage('Prepare Build') 
        {
            steps{
              sh"""#!/bin/bash
              rm -fr SeaChartCreator       
              # clone SeaChartCreator 
              git clone https://github.com/stevo01/SeaChartCreator.git
            
              rm -fr OSM_pmd4dl
              git clone https://github.com/stevo01/OSM_pmd4dl.git
              """
            }
    	}
     	
     	stage('FetchTiles') 
        {
            steps{
     		  sh"""#!/bin/bash
     		  cd SeaChartCreator/
              python3 fetch.py -q -i ${params.BUNDLEPATH}/osmcb-catalog-${params.BUNDLENAME}.xml -d /var/lib/SeaChartCreator/work/database/
              """
            }   
        }
    
     	stage('Build KAP Files') 
        {
            steps{
             sh"""#!/bin/bash
         	   cd SeaChartCreator/
         	   python3 build.py -q -r -i ${params.BUNDLEPATH}/osmcb-catalog-${params.BUNDLENAME}.xml -d /var/lib/SeaChartCreator/work/database/
         	   ls /var/lib/SeaChartCreator/work/database/ -l
         	   """
            }
                
        }
     	
     	stage('Generate geojson')
     	{
            steps{
     	    sh """#!/bin/bash
     		cd OSM_pmd4dl
    		python3 kap2geojson.py https://ftp5.gwdg.de -d /pub/misc/openstreetmap/openseamap/charts/kap -f ./../SeaChartCreator/work/kap/ -p ./../SeaChartCreator/sample/atlas/osmcb/sea/osmcb-catalog-${params.BUNDLENAME}.xml
     		"""
            }
     	}
     	
     	stage('Deploy Files') 
        {
     		steps{
            sh """#!/bin/bash
     		cd OSM_pmd4dl
     		ls ./../SeaChartCreator/work/kap/
     	    rsync -e "ssh -i /var/lib/jenkins/id_osm" -av ./../SeaChartCreator/work/kap/*.7z osm-trans@golf.franken.de:charts/kap/
     	    rsync -e "ssh -i /var/lib/jenkins/id_osm" -av ./../SeaChartCreator/work/kap/*.geojson osm-trans@golf.franken.de:charts/kap/
     		"""
     		}
     	} 	
      }  
}