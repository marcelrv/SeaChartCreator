node {

    parameters {
        string(name: 'BUNDLENAME', defaultValue: 'test', description: 'name of chart bundle')
    }
	
    stage('Prepare Build') 
    {
        sh"""#!/bin/bash
        rm -fr SeaChartCreator       
        # clone SeaChartCreator 
        git clone https://github.com/stevo01/SeaChartCreator.git
        
        rm -fr OSM_pmd4dl
        git clone https://github.com/stevo01/OSM_pmd4dl.git
        """
	}
 	
 	stage('FetchTiles') 
    {
 		sh"""#!/bin/bash
 		cd SeaChartCreator/
        python3 fetch.py -q -i ./sample/atlas/osmcb/sea/osmcb-catalog-${params.BUNDLENAME}.xml -d /var/lib/SeaChartCreator/work/database/
 	    """
 	}

 	stage('Build KAP Files') 
    {
 		sh"""#!/bin/bash
 		cd SeaChartCreator/
 		python3 build.py -q -r -i ./sample/atlas/osmcb/sea/osmcb-catalog-${params.BUNDLENAME}.xml -d /var/lib/SeaChartCreator/work/database/
 	    ls /var/lib/SeaChartCreator/work/database/ -l
 	    """
 	}
 	
 	stage('Generate geojson')
 	{
 	    sh """#!/bin/bash
 		cd OSM_pmd4dl
		python3 kap2geojson.py https://ftp5.gwdg.de -d /pub/misc/openstreetmap/openseamap/charts/kap -f ./SeaChartCreator/work/kap/ -p ./sample/atlas/osmcb/sea/osmcb-catalog-${params.BUNDLENAME}.xml
 		"""
 	}
 	
 	stage('Deploy Files') 
    {
 		sh"""#!/bin/bash
 		cd OSM_pmd4dl
 		ls ./../SeaChartCreator/work/kap/
 	    echo rsync -e "ssh -i /var/lib/jenkins/id_osm" -av ./../SeaChartCreator/work/kap/* osm-trans@golf.franken.de:charts/kap/
 		"""
 	} 	
}